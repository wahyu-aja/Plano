<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indomaret Photo Editor - BY WHYUU</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-number {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .photo-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .photo-input {
            text-align: center;
        }

        .photo-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-button {
            display: block;
            padding: 12px 20px;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 14px;
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4);
        }

        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            background: #f9f9f9;
        }

        .preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .process-all-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .process-all-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(40, 167, 69, 0.4);
        }

        .process-all-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3c72;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 40px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .result-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        @media (max-width: 768px) {
            .photo-inputs, .preview-container {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2rem;
            }
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BY WHYUU</h1>
            <p>Indomaret Photo Editor</p>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-number">üè™</div>
                <h3>Nama Toko Global</h3>
            </div>
            <div class="input-group">
                <label for="global-store-name">Nama Toko (untuk semua kartu):</label>
                <input type="text" id="global-store-name" placeholder="Masukkan nama toko (contoh: TACCIPI BONE)" value="TACCIPI BONE">
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    Hasil: <strong>INDOMARET:<span id="store-preview">TACCIPI BONE</span></strong>
                </p>
            </div>
        </div>

        <div id="editor-cards"></div>

        <button class="process-all-button" onclick="processAllPhotos()">
            BUAT SEMUA FOTO
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Memproses foto...</p>
        </div>

        <div class="results-section" id="results"></div>
    </div>

    <script>
        function generateCards() {
            const container = document.getElementById('editor-cards');
            let cardsHTML = '';
            for (let i = 1; i <= 8; i++) {
                cardsHTML += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-number">${i}</div>
                            <h3>Editor Foto ${i}</h3>
                        </div>
                        <div class="photo-inputs">
                            <div class="photo-input">
                                <label>Foto Contoh:</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="contoh-${i}" class="file-input" accept="image/*" onchange="previewImage(this, 'contoh-preview-${i}')">
                                    <label for="contoh-${i}" class="file-input-button">Upload Foto Contoh</label>
                                </div>
                            </div>
                            <div class="photo-input">
                                <label>Foto Realisasi:</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="realisasi-${i}" class="file-input" accept="image/*" onchange="previewImage(this, 'realisasi-preview-${i}')">
                                    <label for="realisasi-${i}" class="file-input-button">Upload Foto Realisasi</label>
                                </div>
                            </div>
                        </div>
                        <div class="preview-container">
                            <div class="preview" id="contoh-preview-${i}">Preview Foto Contoh</div>
                            <div class="preview" id="realisasi-preview-${i}">Preview Foto Realisasi</div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = cardsHTML;
        }

        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function processAllPhotos() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const button = document.querySelector('.process-all-button');
            const globalStoreName = document.getElementById('global-store-name').value.trim();

            if (!globalStoreName) {
                alert('Mohon isi nama toko terlebih dahulu!');
                return;
            }

            loading.style.display = 'block';
            button.disabled = true;
            results.innerHTML = '';

            let validCards = [];
            for (let i = 1; i <= 8; i++) {
                if (document.getElementById(`contoh-${i}`).files[0] && document.getElementById(`realisasi-${i}`).files[0]) {
                    validCards.push(i);
                }
            }

            if (validCards.length === 0) {
                alert('Mohon upload foto contoh dan realisasi pada minimal satu kartu!');
                loading.style.display = 'none';
                button.disabled = false;
                return;
            }

            for (const i of validCards) {
                const contohFile = document.getElementById(`contoh-${i}`).files[0];
                const realisasiFile = document.getElementById(`realisasi-${i}`).files[0];
                try {
                    const canvas = await createComparisonImage(globalStoreName, contohFile, realisasiFile);
                    displayResult(canvas, i, globalStoreName);
                } catch (error) {
                    console.error(`Error processing card ${i}:`, error);
                    displayErrorResult(i, globalStoreName, error.message);
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            loading.style.display = 'none';
            button.disabled = false;
        }

        // --- FUNGSI-FUNGSI BANTUAN YANG DIPERBAIKI ---

        // Fungsi bantuan untuk memuat gambar dari file upload (Contoh & Realisasi)
        // INI ADALAH PERBAIKAN UTAMA UNTUK MENCEGAH KEBOCORAN MEMORI
        function loadUserImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = () => {
                    URL.revokeObjectURL(url); // Langsung hapus URL dari memori setelah dipakai
                    resolve(img);
                };
                img.onerror = (err) => {
                    URL.revokeObjectURL(url);
                    reject(new Error(`Gagal memuat file: ${file.name}`));
                };
                img.src = url;
            });
        }
        
        // Fungsi bantuan untuk memuat gambar template dari path/src
        function loadTemplateImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Gagal memuat template '${src}'. Pastikan file ada di folder yang sama dengan HTML.`));
                img.src = src;
            });
        }
        
        async function createComparisonImage(storeName, contohFile, realisasiFile) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // PERBAIKAN: Gunakan Promise.all untuk memuat SEMUA gambar (template + user)
            // secara bersamaan. Proses gambar hanya akan jalan jika semua berhasil dimuat.
            const [templateImg, contohImg, realisasiImg] = await Promise.all([
                loadTemplateImage('IMG-20250918-WA0268.jpg'),
                loadUserImage(contohFile),
                loadUserImage(realisasiFile)
            ]);

            // --- Logika menggambar, sekarang menggunakan templateImg sebagai dasar ---

            // Atur ukuran canvas sesuai ukuran template
            canvas.width = templateImg.width;
            canvas.height = templateImg.height;
            
            // 1. Gambar template sebagai background
            ctx.drawImage(templateImg, 0, 0);

            // 2. Tulis nama toko (menggunakan logika dari kode asli Anda)
            const nameAreaX = canvas.width * 0.045;
            const nameAreaY = canvas.height * 0.06;
            const nameAreaWidth = canvas.width * 0.91;
            const nameAreaHeight = canvas.height * 0.15;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(nameAreaX, nameAreaY, nameAreaWidth, nameAreaHeight);
            
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.strokeRect(nameAreaX, nameAreaY, nameAreaWidth, nameAreaHeight);

            ctx.fillStyle = 'black';
            const fontSize = Math.floor(canvas.height * 0.055);
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'left';
            const textX = nameAreaX + (canvas.width * 0.02);
            const textY = nameAreaY + (nameAreaHeight * 0.65);
            ctx.fillText('INDOMARET:' + storeName.toUpperCase(), textX, textY);

            // 3. Gambar foto Contoh dan Realisasi di atas template
            const photoStartY = canvas.height * 0.37;
            const photoAreaHeight = canvas.height * 0.52;
            const photoAreaWidth = canvas.width * 0.43;
            
            const contohX = canvas.width * 0.055;
            const realisasiX = canvas.width * 0.515;

            ctx.drawImage(contohImg, contohX, photoStartY, photoAreaWidth, photoAreaHeight);
            ctx.drawImage(realisasiImg, realisasiX, photoStartY, photoAreaWidth, photoAreaHeight);
            
            return canvas;
        }

        // --- Akhir dari fungsi yang diperbaiki ---

        function displayResult(canvas, cardNumber, storeName) {
            const results = document.getElementById('results');
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            resultCard.innerHTML = `
                <h3>Hasil Foto ${cardNumber} - ${storeName}</h3>
                <canvas class="result-canvas" id="result-canvas-${cardNumber}"></canvas>
                <div>
                    <button class="download-button" onclick="downloadImage(${cardNumber}, '${storeName}')">
                        Download Foto
                    </button>
                </div>
            `;
            results.appendChild(resultCard);
            
            const resultCanvas = document.getElementById(`result-canvas-${cardNumber}`);
            resultCanvas.width = canvas.width;
            resultCanvas.height = canvas.height;
            const resultCtx = resultCanvas.getContext('2d');
            resultCtx.drawImage(canvas, 0, 0);
        }

        function displayErrorResult(cardNumber, storeName, errorMessage) {
            const results = document.getElementById('results');
            results.innerHTML += `
                <div class="result-card" style="border: 2px solid #dc3545;">
                    <h3 style="color: #dc3545;">Error - Foto ${cardNumber} - ${storeName}</h3>
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 15px 0;">
                        <p style="color: #dc3545; margin: 0;">
                            <strong>Gagal memproses foto:</strong><br>
                            ${errorMessage}
                        </p>
                    </div>
                </div>
            `;
        }

        function downloadImage(cardNumber, storeName) {
            try {
                const canvas = document.getElementById(`result-canvas-${cardNumber}`);
                const link = document.createElement('a');
                link.download = `INDOMARET_${storeName.replace(/\s+/g, '_')}_${cardNumber}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
            } catch (error) {
                console.error('Download error:', error);
                alert('Gagal mendownload gambar!');
            }
        }

        generateCards();
        
        document.getElementById('global-store-name').addEventListener('input', function() {
            const preview = document.getElementById('store-preview');
            preview.textContent = this.value.trim().toUpperCase() || 'NAMA TOKO ANDA';
        });
    </script>
</body>
</html>
