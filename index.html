<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indomaret Photo Editor - BY WHYUU</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-number {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .photo-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .photo-input {
            text-align: center;
        }

        .photo-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-button {
            display: block;
            padding: 12px 20px;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 14px;
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4);
        }

        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            background: #f9f9f9;
        }

        .preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .process-all-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .process-all-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(40, 167, 69, 0.4);
        }

        .process-all-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            margin-top: 40px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .result-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3c72;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .photo-inputs, .preview-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BY WHYUU</h1>
            <p>Indomaret Photo Editor</p>
        </div>

        <!-- Global Store Name Input -->
        <div class="card">
            <div class="card-header">
                <div class="card-number">üè™</div>
                <h3>Nama Toko Global</h3>
            </div>
            <div class="input-group">
                <label for="global-store-name">Nama Toko (untuk semua kartu):</label>
                <input type="text" id="global-store-name" placeholder="Masukkan nama toko (contoh: TACCIPI BONE)" value="TACCIPI BONE">
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    Hasil: <strong>INDOMARET:<span id="store-preview">TACCIPI BONE</span></strong>
                </p>
            </div>
        </div>

        <div id="editor-cards">
            <!-- Cards will be generated by JavaScript -->
        </div>

        <button class="process-all-button" onclick="processAllPhotos()">
            BUAT SEMUA FOTO
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Memproses foto...</p>
        </div>

        <div class="results-section" id="results">
            <!-- Results will be displayed here -->
        </div>
    </div>

    <script>
        // Generate 8 editor cards
        function generateCards() {
            const container = document.getElementById('editor-cards');
            
            for (let i = 1; i <= 8; i++) {
                const cardHTML = `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-number">${i}</div>
                            <h3>Editor Foto ${i}</h3>
                        </div>

                        <div class="photo-inputs">
                            <div class="photo-input">
                                <label>Foto Contoh:</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="contoh-${i}" class="file-input" accept="image/*" onchange="previewImage(this, 'contoh-preview-${i}')">
                                    <label for="contoh-${i}" class="file-input-button">Upload Foto Contoh</label>
                                </div>
                            </div>
                            
                            <div class="photo-input">
                                <label>Foto Realisasi:</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="realisasi-${i}" class="file-input" accept="image/*" onchange="previewImage(this, 'realisasi-preview-${i}')">
                                    <label for="realisasi-${i}" class="file-input-button">Upload Foto Realisasi</label>
                                </div>
                            </div>
                        </div>

                        <div class="preview-container">
                            <div class="preview" id="contoh-preview-${i}">
                                Preview Foto Contoh
                            </div>
                            <div class="preview" id="realisasi-preview-${i}">
                                Preview Foto Realisasi
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            }
        }

        // Preview uploaded image
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Process all photos
        async function processAllPhotos() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const button = document.querySelector('.process-all-button');
            const globalStoreName = document.getElementById('global-store-name').value.trim();
            
            if (!globalStoreName) {
                alert('Mohon isi nama toko terlebih dahulu!');
                return;
            }
            
            // Show loading
            loading.style.display = 'block';
            button.disabled = true;
            results.innerHTML = '';

            // Count valid cards
            let validCards = [];
            for (let i = 1; i <= 8; i++) {
                const contohFile = document.getElementById(`contoh-${i}`).files[0];
                const realisasiFile = document.getElementById(`realisasi-${i}`).files[0];
                if (contohFile && realisasiFile) {
                    validCards.push(i);
                }
            }

            if (validCards.length === 0) {
                alert('Mohon upload foto contoh dan realisasi pada minimal satu kartu!');
                loading.style.display = 'none';
                button.disabled = false;
                return;
            }

            console.log(`Processing ${validCards.length} cards:`, validCards);

            // Process each valid card with delay to prevent memory issues
            for (let index = 0; index < validCards.length; index++) {
                const i = validCards[index];
                const contohFile = document.getElementById(`contoh-${i}`).files[0];
                const realisasiFile = document.getElementById(`realisasi-${i}`).files[0];

                try {
                    console.log(`Processing card ${i}...`);
                    const canvas = await createComparisonImage(globalStoreName, contohFile, realisasiFile, i);
                    displayResult(canvas, i, globalStoreName);
                    console.log(`Card ${i} processed successfully`);
                    
                    // Small delay between processing to prevent browser freeze
                    if (index < validCards.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } catch (error) {
                    console.error(`Error processing card ${i}:`, error);
                    // Show error message for this specific card
                    displayErrorResult(i, globalStoreName, error.message);
                }
            }

            // Hide loading
            loading.style.display = 'none';
            button.disabled = false;
            
            console.log('All cards processed');
        }

        // Create comparison image using template
        function createComparisonImage(storeName, contohFile, realisasiFile, cardNumber) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Load template image first
                const templateImg = new Image();
                templateImg.crossOrigin = "anonymous";
                templateImg.onload = function() {
                    try {
                        // Set canvas size based on template
                        canvas.width = templateImg.width;
                        canvas.height = templateImg.height;
                        
                        // Draw template background
                        ctx.drawImage(templateImg, 0, 0);
                        
                        // Calculate positions based on template proportions
                        const templateWidth = templateImg.width;
                        const templateHeight = templateImg.height;
                        
                        // Store name area - lebih presisi sesuai template
                        const nameAreaX = templateWidth * 0.045; // 4.5% from left
                        const nameAreaY = templateHeight * 0.06; // 6% from top  
                        const nameAreaWidth = templateWidth * 0.91; // 91% of width
                        const nameAreaHeight = templateHeight * 0.15; // 15% of height
                        
                        // Clear and redraw store name area dengan border yang tepat
                        ctx.fillStyle = 'white';
                        ctx.fillRect(nameAreaX, nameAreaY, nameAreaWidth, nameAreaHeight);
                        
                        // Add border to name area
                        ctx.strokeStyle = '#333333';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(nameAreaX, nameAreaY, nameAreaWidth, nameAreaHeight);
                        
                        // Add store name text - posisi lebih akurat
                        ctx.fillStyle = 'black';
                        const fontSize = Math.floor(templateHeight * 0.055); // Lebih kecil untuk pas
                        ctx.font = `bold ${fontSize}px Arial`;
                        ctx.textAlign = 'left';
                        const textX = nameAreaX + (templateWidth * 0.02); // 2% padding dari kiri
                        const textY = nameAreaY + (nameAreaHeight * 0.65); // Posisi vertikal yang tepat
                        ctx.fillText('INDOMARET:' + storeName, textX, textY);
                        
                        // Calculate photo areas - sesuaikan dengan template
                        const photoStartY = templateHeight * 0.37; // Mulai setelah header CONTOH/REALISASI
                        const photoAreaHeight = templateHeight * 0.52; // Tinggi area foto
                        const photoAreaWidth = templateWidth * 0.43; // Lebar area foto
                        
                        // Left photo area (CONTOH) 
                        const contohX = templateWidth * 0.055;
                        const contohY = photoStartY;
                        
                        // Right photo area (REALISASI)
                        const realisasiX = templateWidth * 0.515;
                        const realisasiY = photoStartY;
                        
                        // Load and draw user images
                        let userImagesLoaded = 0;
                        let hasError = false;
                        
                        function checkUserImagesComplete() {
                            userImagesLoaded++;
                            if (userImagesLoaded === 2) {
                                if (hasError) {
                                    reject(new Error('Failed to load user images'));
                                } else {
                                    resolve(canvas);
                                }
                            }
                        }
                        
                        // Load contoh image
                        const contohImg = new Image();
                        contohImg.onload = function() {
                            try {
                                // Maintain aspect ratio
                                const aspectRatio = contohImg.width / contohImg.height;
                                let drawWidth = photoAreaWidth;
                                let drawHeight = photoAreaHeight;
                                let drawX = contohX;
                                let drawY = contohY;
                                
                                if (aspectRatio > (photoAreaWidth / photoAreaHeight)) {
                                    drawHeight = photoAreaWidth / aspectRatio;
                                    drawY = contohY + (photoAreaHeight - drawHeight) / 2;
                                } else {
                                    drawWidth = photoAreaHeight * aspectRatio;
                                    drawX = contohX + (photoAreaWidth - drawWidth) / 2;
                                }
                                
                                ctx.drawImage(contohImg, drawX, drawY, drawWidth, drawHeight);
                                checkUserImagesComplete();
                            } catch (err) {
                                console.error('Error drawing contoh image:', err);
                                hasError = true;
                                checkUserImagesComplete();
                            }
                        };
                        contohImg.onerror = function(err) {
                            console.error('Error loading contoh image:', err);
                            hasError = true;
                            checkUserImagesComplete();
                        };
                        contohImg.src = URL.createObjectURL(contohFile);
                        
                        // Load realisasi image
                        const realisasiImg = new Image();
                        realisasiImg.onload = function() {
                            try {
                                // Maintain aspect ratio
                                const aspectRatio = realisasiImg.width / realisasiImg.height;
                                let drawWidth = photoAreaWidth;
                                let drawHeight = photoAreaHeight;
                                let drawX = realisasiX;
                                let drawY = realisasiY;
                                
                                if (aspectRatio > (photoAreaWidth / photoAreaHeight)) {
                                    drawHeight = photoAreaWidth / aspectRatio;
                                    drawY = realisasiY + (photoAreaHeight - drawHeight) / 2;
                                } else {
                                    drawWidth = photoAreaHeight * aspectRatio;
                                    drawX = realisasiX + (photoAreaWidth - drawWidth) / 2;
                                }
                                
                                ctx.drawImage(realisasiImg, drawX, drawY, drawWidth, drawHeight);
                                checkUserImagesComplete();
                            } catch (err) {
                                console.error('Error drawing realisasi image:', err);
                                hasError = true;
                                checkUserImagesComplete();
                            }
                        };
                        realisasiImg.onerror = function(err) {
                            console.error('Error loading realisasi image:', err);
                            hasError = true;
                            checkUserImagesComplete();
                        };
                        realisasiImg.src = URL.createObjectURL(realisasiFile);
                        
                    } catch (err) {
                        console.error('Error in template processing:', err);
                        reject(err);
                    }
                };
                
                templateImg.onerror = function() {
                    console.log('Template not found, using fallback design');
                    try {
                        // Fallback to creating template programmatically
                        canvas.width = 1080;
                        canvas.height = 1080;
                        
                        // Create blue gradient background matching Indomaret colors
                        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                        gradient.addColorStop(0, '#1e3c72');
                        gradient.addColorStop(0.5, '#2a5298');
                        gradient.addColorStop(1, '#4A90E2');
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Add some design elements
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                        for (let i = 0; i < 8; i++) {
                            ctx.fillRect(i * 150, 0, 80, canvas.height);
                        }
                        
                        // Store name background
                        ctx.fillStyle = 'white';
                        ctx.fillRect(60, 60, canvas.width - 120, 120);
                        ctx.strokeStyle = '#333333';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(60, 60, canvas.width - 120, 120);
                        
                        // Store name text
                        ctx.fillStyle = 'black';
                        ctx.font = 'bold 48px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText('INDOMARET:' + storeName, 90, 135);
                        
                        // Section backgrounds
                        ctx.fillStyle = 'white';
                        ctx.fillRect(60, 220, 450, 60); // CONTOH header
                        ctx.fillRect(570, 220, 450, 60); // REALISASI header
                        ctx.fillRect(60, 280, 450, 720); // CONTOH area
                        ctx.fillRect(570, 280, 450, 720); // REALISASI area
                        
                        // Section borders
                        ctx.strokeStyle = '#333333';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(60, 220, 450, 780);
                        ctx.strokeRect(570, 220, 450, 780);
                        
                        // Section titles
                        ctx.fillStyle = 'black';
                        ctx.font = 'bold 40px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('CONTOH', 285, 260);
                        ctx.fillText('REALISASI', 795, 260);
                        
                        // Load user images for fallback
                        let fallbackImagesLoaded = 0;
                        let fallbackError = false;
                        
                        function checkFallbackComplete() {
                            fallbackImagesLoaded++;
                            if (fallbackImagesLoaded === 2) {
                                if (fallbackError) {
                                    reject(new Error('Failed to load images in fallback mode'));
                                } else {
                                    resolve(canvas);
                                }
                            }
                        }
                        
                        const contohImg = new Image();
                        contohImg.onload = function() {
                            try {
                                ctx.drawImage(contohImg, 80, 300, 410, 680);
                                checkFallbackComplete();
                            } catch (err) {
                                fallbackError = true;
                                checkFallbackComplete();
                            }
                        };
                        contohImg.onerror = function() {
                            fallbackError = true;
                            checkFallbackComplete();
                        };
                        contohImg.src = URL.createObjectURL(contohFile);
                        
                        const realisasiImg = new Image();
                        realisasiImg.onload = function() {
                            try {
                                ctx.drawImage(realisasiImg, 590, 300, 410, 680);
                                checkFallbackComplete();
                            } catch (err) {
                                fallbackError = true;
                                checkFallbackComplete();
                            }
                        };
                        realisasiImg.onerror = function() {
                            fallbackError = true;
                            checkFallbackComplete();
                        };
                        realisasiImg.src = URL.createObjectURL(realisasiFile);
                        
                    } catch (err) {
                        console.error('Error in fallback processing:', err);
                        reject(err);
                    }
                };
                
                // Try to load template image
                templateImg.src = 'IMG-20250918-WA0268.jpg';
            });
        }

        // Display result
        function displayResult(canvas, cardNumber, storeName) {
            const results = document.getElementById('results');
            
            const resultHTML = `
                <div class="result-card">
                    <h3>Hasil Foto ${cardNumber} - ${storeName}</h3>
                    <canvas class="result-canvas" id="result-canvas-${cardNumber}"></canvas>
                    <div>
                        <button class="download-button" onclick="downloadImage(${cardNumber}, '${storeName}')">
                            Download Foto
                        </button>
                    </div>
                </div>
            `;
            
            results.innerHTML += resultHTML;
            
            // Copy canvas to result canvas
            const resultCanvas = document.getElementById(`result-canvas-${cardNumber}`);
            const resultCtx = resultCanvas.getContext('2d');
            resultCanvas.width = canvas.width;
            resultCanvas.height = canvas.height;
            resultCtx.drawImage(canvas, 0, 0);
        }

        // Display error result
        function displayErrorResult(cardNumber, storeName, errorMessage) {
            const results = document.getElementById('results');
            
            const errorHTML = `
                <div class="result-card" style="border: 2px solid #dc3545;">
                    <h3 style="color: #dc3545;">Error - Foto ${cardNumber} - ${storeName}</h3>
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 15px 0;">
                        <p style="color: #dc3545; margin: 0;">
                            <strong>Gagal memproses foto:</strong><br>
                            ${errorMessage}
                        </p>
                    </div>
                    <p style="font-size: 14px; color: #666;">
                        Pastikan file gambar valid dan coba lagi.
                    </p>
                </div>
            `;
            
            results.innerHTML += errorHTML;
        }

        // Download image
        function downloadImage(cardNumber, storeName) {
            try {
                const canvas = document.getElementById(`result-canvas-${cardNumber}`);
                if (!canvas) {
                    alert('Canvas tidak ditemukan!');
                    return;
                }
                
                const link = document.createElement('a');
                link.download = `INDOMARET_${storeName}_${cardNumber}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`Downloaded: INDOMARET_${storeName}_${cardNumber}.png`);
            } catch (error) {
                console.error('Download error:', error);
                alert('Gagal mendownload gambar!');
            }
        }

        // Initialize the page
        generateCards();
        
        // Update store name preview
        document.getElementById('global-store-name').addEventListener('input', function() {
            const preview = document.getElementById('store-preview');
            const value = this.value.trim();
            preview.textContent = value || 'TACCIPI BONE';
        });
    </script>
</body>
</html>
